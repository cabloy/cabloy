<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>packages/egg-born-bin/lib/cmd/backend-test.js - CabloyJS API</title>
    
    
    
    
    
    <meta property="og:title" content="CabloyJS API"/>
    <meta property="og:type" content=""/>
    <meta property="og:image" content=""/>
    <meta property="og:site_name" content="CabloyJS API"/>
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="search" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://cabloy.com" target="_blank" class="menu-item" id="documentations_link" >Documentations</a></h2><h2><a href="https://community.cabloy.com" target="_blank" class="menu-item" id="community_link" >Community</a></h2><h3>Modules</h3><ul><li><a href="module-a-base_front_config.html">a-base/front/config</a></li><li><a href="module-a-base_front_mixins.html">a-base/front/mixins</a></li><li><a href="module-a-base_front_mixins_ebActionBase.html">a-base/front/mixins/ebActionBase</a></li><li><a href="module-a-base_front_mixins_ebAtomClasses.html">a-base/front/mixins/ebAtomClasses</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-a-base_front_mixins_ebAtomClasses.html#getAtomClass#~getAtomClass">getAtomClass</a></li></ul></li><li><a href="module-a-basefront_front_pages_base_alert.html">a-basefront/front/pages/base/alert</a></li><li><a href="module-a-components_front_components_eb-stats-color.html">a-components/front/components/eb-stats-color</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-a-components_front_components_eb-stats-color.html#onAdjustValue#~onAdjustValue">onAdjustValue</a></li><li data-type='method' style='display: none;'><a href="module-a-components_front_components_eb-stats-color.html#onChange#~onChange">onChange</a></li></ul></li><li><a href="module-egg-born-front_base_config.html">egg-born-front/base/config</a></li><li><a href="module-project_build_config.html">project/build/config</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">packages/egg-born-bin/lib/cmd/backend-test.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const path = require('path');
const fs = require('fs');
const chalk = require('chalk');
const globby = require('globby');
const mock = require('egg-mock');
const TestCommand = require('@zhennann/egg-bin').TestCommand;
const utils = require('../utils.js');
const eventAppReady = 'eb:event:appReady';

class BackendTestCommand extends TestCommand {
  constructor(rawArgv) {
    super(rawArgv);
    this.usage = 'Usage: egg-born-bin backend-test';
  }

  *run(context) {
    if (context.argv.timeout === undefined) context.argv.timeout = 3600 * 1000;

    if (!context.env.EGG_BASE_DIR) context.env.EGG_BASE_DIR = path.join(process.cwd(), 'src/backend');
    if (!context.env.EGG_FRAMEWORK) context.env.EGG_FRAMEWORK = utils.getModulePath('egg-born-backend');

    context.argv._ = utils.combineTestPattern({
      baseDir: context.env.EGG_BASE_DIR,
      env: 'unittest',
      pattern: context.argv._,
    });

    if (!context.argv._.length) {
      // options
      const options = {};
      options.baseDir = context.env.EGG_BASE_DIR;
      options.framework = context.env.EGG_FRAMEWORK;

      // env
      mock.env('unittest');
      // app
      const app = mock.app(options);
      yield app.ready();

      // check app ready
      yield this.checkAppReady(app);

      // done
      console.log(chalk.cyan('  backend-test successfully!'));
      process.exit(0);
    } else {
      // run
      yield super.run(context);
    }
  }

  /**
   * format test args then change it to array style
   * @param {Object} context - { cwd, argv, ...}
   * @param context.argv
   * @param context.debugOptions
   * @return {Array} [ '--require=xxx', 'xx.test.js' ]
   * @protected
   */
  *formatTestArgs({ argv, debugOptions }) {
    const testArgv = Object.assign({}, argv);

    /* istanbul ignore next */
    testArgv.timeout = testArgv.timeout || process.env.TEST_TIMEOUT || 60000;
    testArgv.reporter = testArgv.reporter || process.env.TEST_REPORTER;
    // force exit
    testArgv.exit = true;

    // whether is debug mode, if pass --inspect then `debugOptions` is valid
    // others like WebStorm 2019 will pass NODE_OPTIONS, and egg-bin itself will be debug, so could detect `process.env.JB_DEBUG_FILE`.

    if (debugOptions || process.env.JB_DEBUG_FILE) {
      // --no-timeout
      testArgv.timeout = false;
    }

    // collect require
    let requireArr = testArgv.require || testArgv.r || [];
    /* istanbul ignore next */
    if (!Array.isArray(requireArr)) requireArr = [requireArr];

    // clean mocha stack, inspired by https://github.com/rstacruz/mocha-clean
    // [mocha built-in](https://github.com/mochajs/mocha/blob/master/lib/utils.js#L738) don't work with `[npminstall](https://github.com/cnpm/npminstall)`, so we will override it.
    if (!testArgv.fullTrace) requireArr.unshift(require.resolve('@zhennann/egg-bin/lib/mocha-clean'));

    // requireArr.push(require.resolve('co-mocha'));

    if (requireArr.includes('intelli-espower-loader')) {
      console.warn("[egg-bin] don't need to manually require `intelli-espower-loader` anymore");
    } else {
      requireArr.push(require.resolve('intelli-espower-loader'));
    }

    // for power-assert
    if (testArgv.typescript) {
      // remove ts-node in context getter on top.
      requireArr.push(require.resolve('espower-typescript/guess'));
    }

    testArgv.require = requireArr;

    let pattern;
    // changed
    if (testArgv.changed) {
      pattern = yield this._getChangedTestFiles();
      if (!pattern.length) {
        console.log('No changed test files');
        return;
      }
    }

    if (!pattern) {
      // specific test files
      pattern = testArgv._.slice();
    }
    if (!pattern.length &amp;&amp; process.env.TESTS) {
      pattern = process.env.TESTS.split(',');
    }

    // collect test files
    if (!pattern.length) {
      pattern = [`test/**/*.test.${testArgv.typescript ? 'ts' : 'js'}`];
    }
    // by zhennann
    // pattern = pattern.concat([ '!test/fixtures', '!test/node_modules' ]);

    // expand glob and skip node_modules and fixtures
    const files = globby.sync(pattern);
    files.sort();

    if (files.length === 0) {
      console.log(`No test files found with ${pattern}`);
      return;
    }

    // auto add setup file as the first test file
    const setupFile = path.join(process.cwd(), `test/.setup.${testArgv.typescript ? 'ts' : 'js'}`);
    if (fs.existsSync(setupFile)) {
      files.unshift(setupFile);
    }
    testArgv._ = files;

    // remove alias
    testArgv.$0 = undefined;
    testArgv.r = undefined;
    testArgv.t = undefined;
    testArgv.g = undefined;
    testArgv.typescript = undefined;
    testArgv['dry-run'] = undefined;
    testArgv.dryRun = undefined;

    return this.helper.unparseArgv(testArgv);
  }

  checkAppReady(app) {
    return new Promise((resolve, reject) => {
      app.on(eventAppReady, () => {
        resolve();
      });
    });
  }

  description() {
    return 'backend test';
  }
}

module.exports = BackendTestCommand;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Fri Apr 08 2022 01:36:49 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/collapse.js"></script>


<script src="scripts/search.js"></script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?702a5fbeaa29235d5d07e5233d8a591b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</body>
</html>
